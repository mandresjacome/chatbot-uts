<!doctype html>
<html lang="es" data-theme="light">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Panel Admin — AvaUTS v2.0.0</title>
  <link rel="stylesheet" href="./css/base.css" />
  <link rel="stylesheet" href="./css/metrics.css" />
  <link rel="stylesheet" href="./css/feedback.css" />
  <link rel="stylesheet" href="./css/knowledge.css" />
  <link rel="stylesheet" href="./css/maintenance.css" />
</head>
<body>
  <header class="header">
    <h1>
      <img src="/assets/animations/ChatbotVerdeUTS.gif" alt="AvaUTS">
      AvaUTS — Panel de Administración v2.0
    </h1>
    <div class="header-controls">
      <button id="themeToggle" title="Tema">🌓</button>
      <span class="badge">UTS</span>
    </div>
  </header>

  <nav class="nav-tabs">
    <button class="tab-btn active" data-tab="metrics">📊 Métricas</button>
    <button class="tab-btn" data-tab="feedback">💬 Feedback</button>
    <button class="tab-btn" data-tab="knowledge">📚 Base de Conocimiento</button>
    <button class="tab-btn" data-tab="maintenance">⚙️ Mantenimiento</button>
  </nav>

  <main class="container">
    <!-- SECCIÓN 1: MÉTRICAS (solo lectura) -->
    <section id="metrics-section" class="tab-content active">
      <div class="section-header">
        <h2>📊 Métricas del Sistema</h2>
        <button id="refreshMetrics" class="btn btn-outline">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M3 3V9M3 9H9M3 9L6.5 5.5C8.28 3.72 10.86 2.5 13.5 2.5C18.19 2.5 22 6.31 22 11C22 15.69 18.19 19.5 13.5 19.5C10.25 19.5 7.5 17.86 6.06 15.31" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
          Actualizar
        </button>
      </div>
      
      <div class="metrics-cards">
        <div class="metric-card">
          <div class="metric-icon">💬</div>
          <div class="metric-content">
            <div class="metric-title">Conversaciones Totales</div>
            <div id="totalConversations" class="metric-value">—</div>
          </div>
        </div>

        <div class="metric-card">
          <div class="metric-icon">😊</div>
          <div class="metric-content">
            <div class="metric-title">Satisfacción</div>
            <div id="satisfactionRate" class="metric-value">—%</div>
            <div class="progress-bar">
              <div id="satisfactionBar" class="progress-fill" style="width: 0%"></div>
            </div>
          </div>
        </div>

        <div class="metric-card">
          <div class="metric-icon">📝</div>
          <div class="metric-content">
            <div class="metric-title">Feedback Recibido</div>
            <div id="feedbackTotal" class="metric-value">—</div>
            <div id="feedbackPos" class="metric-subtitle">— positivos</div>
          </div>
        </div>

        <div class="metric-card">
          <div class="metric-icon">⚙️</div>
          <div class="metric-content">
            <div class="metric-title">Estado del Sistema</div>
            <div id="statusMetrics" class="metric-value status-indicator">Verificando...</div>
          </div>
        </div>
      </div>

      <div class="recent-conversations">
        <div class="section-header">
          <h3>💬 Conversaciones Recientes</h3>
        </div>
        <div class="table-container">
          <table class="data-table">
            <thead>
              <tr>
                <th>ID</th>
                <th>Usuario</th>
                <th>Pregunta</th>
                <th>Respuesta</th>
                <th>Fecha</th>
              </tr>
            </thead>
            <tbody id="lastConversations">
              <tr><td colspan="5" class="loading">Cargando...</td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- SECCIÓN 2: FEEDBACK -->
    <section id="feedback-section" class="tab-content">
      <div class="section-header">
        <h2>💬 Gestión de Feedback</h2>
        <p class="section-description">
          Revisa los comentarios y calificaciones de los usuarios para mejorar el servicio del chatbot.
        </p>
      </div>

      <!-- ESTADÍSTICAS DE FEEDBACK -->
      <div class="kb-stats">
        <div class="kb-stat">
          <div class="kb-stat-value" id="feedbackStatsTotal">0</div>
          <div class="kb-stat-label">📊 Total Votos</div>
        </div>
        <div class="kb-stat">
          <div class="kb-stat-value" id="feedbackStatsPositive">0</div>
          <div class="kb-stat-label">👍 Respuestas Útiles</div>
        </div>
        <div class="kb-stat">
          <div class="kb-stat-value" id="feedbackStatsNegative">0</div>
          <div class="kb-stat-label">👎 Respuestas No Útiles</div>
        </div>
      </div>

      <!-- FILTROS DE FEEDBACK -->
      <div class="action-card">
        <div class="action-header">
          <h3>🔍 Filtros</h3>
        </div>
        <div class="filters-row">
          <div class="filter-group">
            <label for="feedbackType">Tipo:</label>
            <select id="feedbackType" class="filter-select">
              <option value="all">Todos los votos</option>
              <option value="positive">Solo útiles</option>
              <option value="negative">Solo no útiles</option>
            </select>
          </div>
          <div class="filter-group">
            <label for="feedbackPeriod">Período:</label>
            <select id="feedbackPeriod" class="filter-select">
              <option value="all">Todo el tiempo</option>
              <option value="today">Hoy</option>
              <option value="week">Última semana</option>
              <option value="month">Último mes</option>
            </select>
          </div>
          <button id="applyFeedbackFilters" class="btn btn-primary">
            <span class="btn-icon">🔍</span>
            Aplicar Filtros
          </button>
        </div>
      </div>

      <!-- LISTA DE FEEDBACK -->
      <div class="action-card">
        <div class="action-header">
          <h3>📝 Votaciones de Usuarios</h3>
        </div>
        <div id="feedbackContainer" class="feedback-list">
          <div class="loading-state">
            <div class="loading-icon">⏳</div>
            <div>Cargando feedback...</div>
          </div>
        </div>
      </div>
    </section>

    <!-- SECCIÓN 3: BASE DE CONOCIMIENTO -->
    <section id="knowledge-section" class="tab-content">
      <div class="section-header">
        <h2>📚 Base de Conocimiento</h2>
        <p class="section-description">
          Gestiona las preguntas y respuestas de la base de conocimiento del chatbot.
        </p>
      </div>

      <!-- ESTADÍSTICAS DE KB -->
      <div class="kb-stats">
        <div class="kb-stat">
          <div class="kb-stat-value" id="kbStatsTotal">0</div>
          <div class="kb-stat-label">📝 Total Entradas</div>
        </div>
        <div class="kb-stat">
          <div class="kb-stat-value" id="kbStatsStudents">0</div>
          <div class="kb-stat-label">🎓 Estudiantes</div>
        </div>
        <div class="kb-stat">
          <div class="kb-stat-value" id="kbStatsTeachers">0</div>
          <div class="kb-stat-label">👨‍🏫 Docentes</div>
        </div>
        <div class="kb-stat">
          <div class="kb-stat-value" id="kbStatsAspirants">0</div>
          <div class="kb-stat-label">🌟 Aspirantes</div>
        </div>
        <div class="kb-stat">
          <div class="kb-stat-value" id="kbStatsGeneral">0</div>
          <div class="kb-stat-label">👥 Todos/Visitantes</div>
        </div>
      </div>

      <!-- CONTROLES DE KB -->
      <div class="action-card">
        <div class="action-header">
          <h3>🔍 Buscar en Base de Conocimiento</h3>
        </div>
        <div class="kb-search-controls">
          <div class="kb-search-row">
            <input type="text" id="kbSearchInput" placeholder="Buscar preguntas, respuestas o palabras clave..." class="kb-search-input">
            <button id="kbSearchBtn" class="btn btn-primary">
              <span class="btn-icon">🔍</span>
              Buscar
            </button>
            <button id="kbClearSearch" class="btn btn-secondary">
              <span class="btn-icon">🗑️</span>
              Limpiar
            </button>
            <button id="refreshKnowledge" class="btn btn-info">
              <span class="btn-icon">🔄</span>
              Actualizar
            </button>
          </div>
        </div>
      </div>

      <!-- TABLA DE CONOCIMIENTO -->
      <div class="action-card">
        <div class="action-header">
          <h3>📋 Entradas de la Base de Conocimiento</h3>
        </div>
        <div class="kb-table-wrapper">
          <table class="data-table">
            <thead>
              <tr>
                <th>ID</th>
                <th>Pregunta</th>
                <th>Tipo Usuario</th>
                <th>Fuente</th>
                <th>Actualizado</th>
                <th>Acciones</th>
              </tr>
            </thead>
            <tbody id="knowledgeTable">
              <tr>
                <td colspan="6" class="loading">
                  <div class="loading-state">
                    <div class="loading-icon">⏳</div>
                    <div>Cargando base de conocimiento...</div>
                  </div>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- SECCIÓN 4: MANTENIMIENTO -->
    <section id="maintenance-section" class="tab-content">
      <div class="section-header">
        <h2>⚙️ Mantenimiento del Sistema</h2>
        <p class="section-description">
          Panel principal para el mantenimiento del chatbot AvaUTS. 
          Las funciones principales están siempre visibles, las específicas se pueden expandir según sea necesario.
        </p>
      </div>

      <!-- AUTENTICACIÓN -->
      <div id="authenticationCard" class="action-card">
        <div class="action-header">
          <h3>🔐 Autenticación de Administrador</h3>
          <span class="action-status" id="authStatus">No autenticado</span>
        </div>
        <p>Para usar las funciones de mantenimiento, primero debes autenticarte como administrador.</p>
        <div class="auth-form">
          <input type="password" id="adminToken" placeholder="Ingresa el token de administrador..." class="auth-input">
          <button id="authenticateBtn" class="btn btn-primary">
            <span class="btn-icon">🔑</span>
            Autenticar
          </button>
        </div>
        <div id="authOutput" class="action-output"></div>
      </div>

      <div id="maintenanceControls" class="maintenance-controls" style="display: none;">
        <!-- ESTADO DEL SISTEMA -->
        <div class="action-card">
          <div class="action-header">
            <h3>📊 Estado del Sistema</h3>
            <span class="action-status" id="systemStatus">Verificando...</span>
          </div>
          <p>Información general sobre el estado del chatbot y sus componentes principales.</p>
          <div class="system-info">
            <div class="info-item">
              <span class="info-label">Servidor:</span>
              <span id="serverStatus" class="info-value">—</span>
            </div>
            <div class="info-item">
              <span class="info-label">Base de datos:</span>
              <span id="dbStatus" class="info-value">—</span>
            </div>
            <div class="info-item">
              <span class="info-label">IA (Gemini):</span>
              <span id="aiStatus" class="info-value">—</span>
            </div>
            <div class="info-item">
              <span class="info-label">Registros KB:</span>
              <span id="kbRecordsStatus" class="info-value">—</span>
            </div>
            <div class="info-item">
              <span class="info-label">Última actualización:</span>
              <span id="lastUpdateStatus" class="info-value">—</span>
            </div>
          </div>
          <button id="checkSystemBtn" class="btn btn-info">
            <span class="btn-icon">🔍</span>
            Verificar Estado
          </button>
        </div>

        <!-- MANTENIMIENTO AUTOMÁTICO -->
        <div class="action-card">
          <div class="action-header">
            <h3>🤖 Mantenimiento Automático</h3>
            <span class="action-status" id="configStatus">Disponible</span>
          </div>
          <div class="auto-maintenance-description">
            <p><strong>¿Qué hace este botón?</strong></p>
            <ul>
              <li>🔍 <strong>Revisa</strong> si hay cambios en el sitio web de UTS</li>
              <li>🌐 <strong>Actualiza</strong> automáticamente la información del chatbot</li>
              <li>👥 <strong>Sincroniza</strong> los datos de docentes</li>
              <li>🎯 <strong>Mejora</strong> las palabras clave para mejores respuestas</li>
            </ul>
            <div class="maintenance-note">
              <strong>💡 Para la secretaria:</strong> Presiona el botón verde y el sistema hará todo solo. 
              Tardará unos minutos y te avisará cuando termine. ¡No necesitas saber nada técnico!
            </div>
          </div>
          <div class="action-buttons">
            <button id="autoMaintenanceBtn" class="btn btn-success">
              <span class="btn-icon">🤖</span>
              Mantenimiento Automático
            </button>
            <button id="viewLogsBtn" class="btn btn-outline">
              <span class="btn-icon">📋</span>
              Ver Logs
            </button>
          </div>
          <div id="configOutput" class="action-output"></div>
        </div>

        <!-- SECCIÓN EXPANDIBLE PARA FUNCIONES ESPECÍFICAS -->
        <div class="specific-functions-section">
          <div class="expand-header" id="expandSpecificFunctions">
            <div class="expand-content">
              <h3>🔧 Mantenimiento Específico</h3>
              <p>¿Necesitas hacer algo específico? Haz clic aquí para ver más opciones</p>
            </div>
            <div class="expand-toggle">
              <span class="expand-icon">▼</span>
            </div>
          </div>

          <div class="expandable-content" id="specificFunctionsContent">
            <div class="functions-tabs">
              <div class="function-tabs-nav">
                <button class="function-tab-btn active" data-target="automation-functions">
                  🤖 Automatización
                </button>
                <button class="function-tab-btn" data-target="teachers-functions">
                  👥 Docentes  
                </button>
                <button class="function-tab-btn" data-target="search-functions">
                  🔍 Búsqueda
                </button>
                <button class="function-tab-btn" data-target="suggestions-functions">
                  💡 Sugerencias
                </button>
                <button class="function-tab-btn" data-target="scrapers-functions">
                  🌐 Scrapers
                </button>
                <button class="function-tab-btn" data-target="operations-functions">
                  ⚙️ Operaciones
                </button>
              </div>

              <div class="function-tabs-content">
                <!-- Automatización -->
                <div id="automation-functions" class="function-tab-content active">
                  <div class="function-card">
                    <h4>🤖 Sistema de Automatización</h4>
                    <p>Controlar tareas automáticas específicas</p>
                    <div class="action-buttons">
                      <button class="btn btn-info" id="detectChangesBtn">🔍 Detectar Cambios</button>
                      <button class="btn btn-primary" id="autoUpdateBtn">🔄 Auto Update</button>
                    </div>
                    <div id="automationOutput" class="action-output"></div>
                  </div>
                </div>

                <!-- Docentes -->
                <div id="teachers-functions" class="function-tab-content">
                  <div class="function-card">
                    <h4>👥 Sincronización de Docentes</h4>
                    <p>Gestionar información específica de docentes</p>
                    <div class="action-buttons">
                      <button class="btn btn-success" id="syncTeachersBtn">👥 Sincronizar Docentes</button>
                      <button class="btn btn-info" id="checkTeachersBtn">🔍 Verificar Docentes</button>
                    </div>
                    <div id="teachersOutput" class="action-output"></div>
                  </div>
                </div>

                <!-- Búsqueda -->
                <div id="search-functions" class="function-tab-content">
                  <div class="function-card">
                    <h4>🔍 Optimización de Búsqueda</h4>
                    <p>Mejorar la precisión de las búsquedas del chatbot</p>
                    <div class="action-buttons">
                      <button class="btn btn-warning" id="improveKeywordsBtn">🎯 Mejorar Keywords</button>
                      <button class="btn btn-info" id="generateSynonymsBtn">📝 Generar Sinónimos</button>
                    </div>
                    <div id="searchOutput" class="action-output"></div>
                  </div>
                </div>

                <!-- Sugerencias -->
                <div id="suggestions-functions" class="function-tab-content">
                  <div class="function-card">
                    <h4>💡 Sugerencias Estáticas</h4>
                    <p>Ver y regenerar sugerencias del chatbot</p>
                    <div class="action-buttons">
                      <button class="btn btn-info" id="viewSuggestionsEstudianteBtn">👨‍🎓 Estudiante</button>
                      <button class="btn btn-info" id="viewSuggestionsDocenteBtn">👨‍🏫 Docente</button>
                      <button class="btn btn-info" id="viewSuggestionsAspiranteBtn">🎯 Aspirante</button>
                      <button class="btn btn-info" id="viewSuggestionsAllBtn">📋 Todas</button>
                      <button class="btn btn-success" id="regenerateSuggestionsBtn">🔄 Regenerar</button>
                    </div>
                    <div id="suggestionsOutput" class="action-output"></div>
                  </div>
                </div>

                <!-- Scrapers -->
                <div id="scrapers-functions" class="function-tab-content">
                  <div class="function-card">
                    <h4>🌐 Scrapers Manuales</h4>
                    <p>Obtener datos específicos manualmente</p>
                    <div class="action-buttons">
                      <button class="btn btn-primary" id="runScrapersBtn">🌐 Ejecutar Scrapers</button>
                    </div>
                    <div id="scrapersOutput" class="action-output"></div>
                  </div>
                </div>

                <!-- Operaciones -->
                <div id="operations-functions" class="function-tab-content">
                  <div class="function-card">
                    <h4>⚙️ Operaciones del Sistema</h4>
                    <p>Operaciones avanzadas de mantenimiento</p>
                    <div class="action-buttons">
                      <button class="btn btn-warning" id="reloadKbBtn">📚 Recargar KB</button>
                      <button class="btn btn-danger" id="backupDbBtn">💾 Backup BD</button>
                    </div>
                    <div id="operationsOutput" class="action-output"></div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </section>
  </main>

  <footer class="footer">
    <span>Hecho por Mario Andrés Jácome Mantilla — Unidades Tecnológicas de Santander</span>
  </footer>

  <!-- Scripts modulares -->
  <script src="./js/metrics.js" defer></script>
  <script src="./js/feedback.js" defer></script>
  <script src="./js/knowledge.js" defer></script>
  <script src="./js/maintenance.js" defer></script>
  <script>
    // Sistema de temas y navegación de tabs
    const THEME_KEY = 'uts_theme';
    const htmlEl = document.documentElement;
    const themeToggle = document.getElementById('themeToggle');

    function applyTheme(mode){
      htmlEl.setAttribute('data-theme', mode);
      localStorage.setItem(THEME_KEY, mode);
      themeToggle.textContent = mode === 'dark' ? '🌙' : (mode === 'light' ? '☀️' : '🌓');
    }

    (function initTheme(){
      let saved = localStorage.getItem(THEME_KEY) || 'light';
      // Migrar usuarios que tenían tema automático a tema claro
      if (saved === 'auto') {
        saved = 'light';
        localStorage.setItem(THEME_KEY, saved);
      }
      applyTheme(saved);
    })();

    themeToggle.addEventListener('click', () => {
      const current = htmlEl.getAttribute('data-theme') || 'light';
      const next = current === 'light' ? 'dark' : 'light';
      applyTheme(next);
    });

    // Sistema de navegación de tabs principales
    document.addEventListener('DOMContentLoaded', function() {
      const tabButtons = document.querySelectorAll('.tab-btn');
      const tabContents = document.querySelectorAll('.tab-content');
      
      tabButtons.forEach(button => {
        button.addEventListener('click', function() {
          const targetTab = this.dataset.tab;
          
          // Remover active de todos los botones y secciones
          tabButtons.forEach(btn => btn.classList.remove('active'));
          tabContents.forEach(content => content.classList.remove('active'));
          
          // Agregar active al botón clickeado y su sección
          this.classList.add('active');
          document.getElementById(targetTab + '-section').classList.add('active');
          
          // Inicializar el módulo correspondiente
          switch(targetTab) {
            case 'metrics':
              if (window.initMetrics) window.initMetrics();
              break;
            case 'feedback':
              if (window.initFeedback) window.initFeedback();
              break;
            case 'knowledge':
              if (window.initKnowledge) window.initKnowledge();
              break;
            case 'maintenance':
              if (window.initMaintenance) window.initMaintenance();
              break;
          }
        });
      });

      // Funcionalidad para secciones expandibles
      initExpandableSections();
      
      // Inicializar métricas por defecto (sección activa)
      if (window.initMetrics) {
        window.initMetrics();
      }
    });

    // FUNCIONALIDAD PARA SECCIONES EXPANDIBLES
    function initExpandableSections() {
      // Header expandible
      const expandHeader = document.getElementById('expandSpecificFunctions');
      const expandContent = document.getElementById('specificFunctionsContent');
      
      if (expandHeader && expandContent) {
        expandHeader.addEventListener('click', function() {
          const isExpanded = expandContent.classList.contains('expanded');
          
          if (isExpanded) {
            // Colapsar
            expandContent.classList.remove('expanded');
            expandHeader.classList.remove('expanded');
          } else {
            // Expandir
            expandContent.classList.add('expanded');
            expandHeader.classList.add('expanded');
          }
        });
      }
      
      // Navegación de tabs de funciones
      const tabButtons = document.querySelectorAll('.function-tab-btn');
      const tabContents = document.querySelectorAll('.function-tab-content');
      
      tabButtons.forEach(button => {
        button.addEventListener('click', function() {
          const targetId = this.getAttribute('data-target');
          
          // Remover active de todos los botones y contenidos
          tabButtons.forEach(btn => btn.classList.remove('active'));
          tabContents.forEach(content => content.classList.remove('active'));
          
          // Agregar active al botón clickeado y su contenido
          this.classList.add('active');
          const targetContent = document.getElementById(targetId);
          if (targetContent) {
            targetContent.classList.add('active');
          }
        });
      });
    }
  </script>
</body>
</html>